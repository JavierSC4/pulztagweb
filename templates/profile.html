<!-- templates/profile.html -->

{% extends 'base.html' %}

{% block title %}Perfil de Usuario - PulztagWeb (Escala 1-10 NPS){% endblock %}

{% block head %}
<!-- Se mantiene DataTables y Bootstrap -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">

<style>
  /* ===== Estilos Base (Mobile First) ===== */
  body {
    background-image: url("/static/images/background.jpg") !important;
    background-size: cover;
    background-attachment: fixed;
    background-position: center;
  }
  /* Efecto de pulsación para el logo */
  .pulsate {
    animation: pulse 1.5s infinite;
  }

  @keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
  }

  /* Reservar ancho fijo para los puntos para que no se mueva el contenido */
  #dots {
    display: inline-block;
    width: 30px; /* Ajusta este valor según la cantidad máxima de puntos que vayas a mostrar */
    text-align: left;
  }
  .small-text {
    font-size: 0.9rem; /* tamaño relativo para móviles */
  }

  .d-flex {
    display: flex !important;
  }
  .h-100 {
    height: 100% !important;
  }

  /* Sidebar: por defecto oculto en móviles */
  #sidebar {
    /* Calcula la altura disponible: viewport height menos la suma del header, footer y margen */
    height: calc(100vh - var(--header-height) - var(--footer-height) - var(--sidebar-margin));
    overflow-y: auto;
  }

  /* Contenedor principal con padding reducido para móviles */
  #mainContent {
    padding: 10px;
  }

  /* Ajuste en botones de navbar para móviles */
  .navbar .btn {
    padding: 0.3rem 0.6rem;
  }

  /* Ajuste de offcanvas en móviles */
  .offcanvas-start {
    width: 100%;
  }

  .sidebar-transition {
    transition: all 0.3s;
  }

  .btn-primary {
    background-color: rgba(231,231,231,0.46);
    border-color: #ffffff;
  }
  .btn-primary:hover {
    background-color: #e6e6e6;
    border-color: #b6b6b6;
  }
  .btn-primary:active,
  .btn-primary:focus {
    background-color: #d6d6d6 !important;
    border-color: #a6a6a6 !important;
    box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
  }

  /* Colores para los botones en secciones */
  #dashboardItemActions .btn,
  #dashboardItemStats .btn,
  #miPerfilSection .btn {
    color: rgb(122, 122, 122) !important;
  }
  #dashboardItemActions .btn-danger {
    color: white !important;
  }

  /* Espaciado en botones de acción */
  .action-btn {
    margin-right: 5px;
  }
  @media (max-width: 767.98px) {
    .action-btn span {
      display: none !important;
    }
  }

  /* Sección de Dashboard con layout flexible */
  .dashboard-section {
    background-color: #f8f9fa;
    border: 1px solid #ddd;
    border-radius: 5px;
    padding: 1rem;
    margin-bottom: 1rem;
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    justify-content: flex-end;
    gap: 1rem;
  }

  /* Contenedor del gráfico: uso de porcentajes y límite para pantallas grandes */
  #chartContainer {
    margin: 0 auto;
    padding: 0;
    width: 100%;
    max-width: 1200px;
    height: auto;
  }
  /* Contenedor que forzará la relación de aspecto */
  #chartWrapper {
    width: 100%;
    /* Define la relación de aspecto deseada; por ejemplo, si en una pantalla grande el gráfico es 1200px de ancho y 500px de alto, la relación es 2.4 */
    aspect-ratio: 2.4; 
    position: relative; /* Esto es importante para que el canvas se ajuste correctamente */
  }
  /* El canvas ocupará el 100% del contenedor */
  #myChart {
    width: 100%;
    height: 100%;
  }

  /* Estilos para DataTables y tablas personalizadas */
  #ratingsTable thead th,
  #ratingsTable tbody td,
  #ratingsTable tbody th {
    font-size: 0.875rem;
    white-space: nowrap;
  }
  .table-responsive, .full-width {
    width: 100%;
  }
  .hidden {
    display: none;
  }

  .chartjs-tooltip {
    opacity: 1;
    position: absolute;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    pointer-events: none;
    transition: all 0.1s ease;
  }

  .custom-table thead th {
    background-color: #f8f9fa;
    font-weight: bold;
  }
  .custom-table tbody tr:hover {
    background-color: #f1f1f1;
  }
  #dayDetailsContainer table {
    table-layout: fixed;
    width: 100%;
  }
  #dayDetailsContainer th:first-child,
  #dayDetailsContainer td:first-child {
    width: 170px;
    white-space: nowrap;
  }
  #dayDetailsContainer th:last-child,
  #dayDetailsContainer td:last-child {
    width: auto;
    word-wrap: break-word;
    text-align: start;
  }

  /* ===== Media Queries para pantallas mayores ===== */
  @media (min-width: 768px) {
    /* Mostrar el sidebar en pantallas medianas y grandes */
    #sidebar {
      display: block;
    }
    /* Restablece el padding del mainContent */
    #mainContent {
      padding: 20px;
    }
  }

  /* Ajustes para pantallas extra pequeñas */
  @media (max-width: 575px) {
    #mainContent {
      padding: 5px;
    }
    .small-text {
      font-size: 0.8rem;
    }
    /* Puedes ajustar márgenes o tamaños de fuente adicionales */
  }

  /* Ajuste para que en pantallas pequeñas el gráfico mantenga una proporción de 5:4 */
  @media (max-width: 767px) {
    #chartContainer {
      min-height: calc(100vw * 4 / 5);
    }
    #myChart {
      width: 100% !important;
      height: 100% !important;
    }
  }
</style>
{% endblock %}

{% block content %}
<!-- NAVBAR superior para pantallas pequeñas -->
<nav class="navbar navbar-expand-md navbar-light border-bottom d-md-none">
  <div class="container-fluid">
    <button class="btn btn-secondary" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasSidebar" aria-controls="offcanvasSidebar">
      <i class="bi bi-list"></i> Menú
    </button>
  </div>
</nav>

<div class="d-md-flex h-100">
  <!-- SIDEBAR para pantallas grandes -->
  <div class="d-none d-md-flex flex-column border-end sidebar-transition" id="sidebar" style="flex-shrink: 0;">
    <div class="sidebar-header d-flex align-items-center p-3 border-bottom">
      <div class="user-display">
        <span class="user-fullname">{{ current_user.username }}</span>
      </div>
      <button id="sidebarToggle" class="btn btn-light btn-sm ms-auto" title="Expandir/Contraer Sidebar">
        <i class="bi bi-chevron-left"></i>
      </button>
    </div>

    <ul class="nav flex-column pt-2" id="sidebarMenu">
      <!-- Dashboard -->
      <li class="nav-item mt-2">
        <a href="#" class="nav-link sidebar-link" data-bs-toggle="collapse" data-bs-target="#dashboardSubmenu" aria-expanded="false" aria-controls="dashboardSubmenu" title="Dashboard">
          <i class="fa-regular fa-chart-bar"></i><span class="text-label ms-2">Encuestas</span>
        </a>
        <ul class="collapse list-unstyled ps-0" id="dashboardSubmenu">
          <li>
            <a href="#" class="nav-link sub-link" data-bs-toggle="modal" data-bs-target="#agregarItemModal">
              <i class="bi bi-plus-circle-fill"></i><span class="text-label ms-1">Agregar Item</span>
            </a>
          </li>
          <div id="dashboardItemsContainer">
            {% if dashboard_items %}
              {% for item in dashboard_items %}
              <li>
                <a href="#dashboardItemDetailSection" class="nav-link sub-link dashboard-item-link" data-item-id="{{ item.uuid }}" data-item-name="{{ item.name }}" data-item-type="{{ item.item_type }}">
                  <i class="fa-solid fa-square-poll-vertical"></i><span class="text-label ms-1">{{ item.name }}</span>
                </a>
              </li>
              {% endfor %}
            {% else %}
              <li>
                <span class="text-muted ms-3">Sin items disponibles</span>
              </li>
            {% endif %}
          </div>
        </ul>
      </li>
      <!-- Pulzcards -->
      <li class="nav-item mt-2">
        <a href="#" class="nav-link sidebar-link" data-bs-toggle="collapse" data-bs-target="#pulzcardSubmenu" aria-expanded="false" title="Pulzcards">
          <i class="bi bi-person-badge-fill"></i><span class="text-label ms-2">Pulzcards</span>
        </a>
        <ul class="collapse list-unstyled ps-0" id="pulzcardSubmenu">
          <li>
            <a href="{{ url_for('pulzcard') }}" class="nav-link sub-link">
              <i class="bi bi-plus-circle-fill"></i><span class="text-label ms-1">Crear Nuevo</span>
            </a>
          </li>
          <li>
            <a href="#pulzcardsSection" class="nav-link sub-link">
              <i class="bi bi-eye-fill"></i><span class="text-label ms-1">Ver Todos</span>
            </a>
          </li>
        </ul>
      </li>
      <!-- Etiquetas -->
      <li class="nav-item mt-2">
        <a href="#" class="nav-link sidebar-link" data-bs-toggle="collapse" data-bs-target="#etiquetasSubmenu" aria-expanded="false" title="Etiquetas">
          <i class="bi bi-tags-fill"></i><span class="text-label ms-2">Etiquetas</span>
        </a>
        <ul class="collapse list-unstyled ps-0" id="etiquetasSubmenu">
          <li>
            <a href="#" data-bs-toggle="modal" data-bs-target="#agregarEtiquetaModal" class="nav-link sub-link">
              <i class="bi bi-plus-circle-fill"></i><span class="text-label ms-1">Crear Nuevo</span>
            </a>
          </li>
          <li>
            <a href="#" data-bs-toggle="modal" data-bs-target="#importTagsModal" class="nav-link sub-link" title="Importar Etiquetas">
              <i class="bi bi-file-arrow-up-fill"></i><span class="text-label ms-1">Importar</span>
            </a>
          </li>
          <li>
            <a href="#etiquetasSection" class="nav-link sub-link">
              <i class="bi bi-eye-fill"></i><span class="text-label ms-1">Ver Todos</span>
            </a>
          </li>
        </ul>
      </li>
      <!-- Bodegas -->
      <li class="nav-item mt-2">
        <a href="#" class="nav-link sidebar-link" data-bs-toggle="collapse" data-bs-target="#bodegasSubmenu" aria-expanded="false" title="Bodegas">
          <i class="bi bi-box-fill"></i><span class="text-label ms-2">Bodegas</span>
        </a>
        <ul class="collapse list-unstyled ps-0" id="bodegasSubmenu">
          <li>
            <a href="#" data-bs-toggle="modal" data-bs-target="#agregarBodegaModal" class="nav-link sub-link">
              <i class="bi bi-plus-circle-fill"></i><span class="text-label ms-1">Crear Nueva</span>
            </a>
          </li>
          <li>
            <a href="#bodegasSection" class="nav-link sub-link">
              <i class="bi bi-eye-fill"></i><span class="text-label ms-1">Ver Todas</span>
            </a>
          </li>
        </ul>
      </li>
      <hr class="my-10">
      <!-- Mi Perfil -->
      <li class="nav-item mt-2">
        <a href="#miPerfilSection" class="nav-link sidebar-link" title="Mi Perfil">
          <i class="bi bi-person-lines-fill"></i><span class="text-label ms-2">Mi Perfil</span>
        </a>
      </li>
    </ul>
  </div>

  <!-- Off-canvas Sidebar para pantallas pequeñas -->
  <div class="offcanvas offcanvas-start d-md-none" tabindex="-1" id="offcanvasSidebar" aria-labelledby="offcanvasSidebarLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="offcanvasSidebarLabel">{{ current_user.username }}</h5>
      <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Cerrar"></button>
    </div>
    <div class="offcanvas-body p-0">
      <ul class="nav flex-column pt-2" id="offcanvasSidebarMenu">
        <!-- Dashboard -->
        <li class="nav-item mt-2">
          <a href="#" class="nav-link sidebar-link" data-bs-toggle="collapse" data-bs-target="#dashboardSubmenuOffcanvas" aria-expanded="false" aria-controls="dashboardSubmenuOffcanvas" title="Dashboard">
            <i class="fa-regular fa-chart-bar"></i><span class="text-label ms-2">Encuestas</span>
          </a>
          <ul class="collapse list-unstyled ps-0" id="dashboardSubmenuOffcanvas">
            <li>
              <a href="#" class="nav-link sub-link" data-bs-toggle="modal" data-bs-target="#agregarItemModal">
                <i class="bi bi-plus-circle-fill"></i><span class="text-label ms-1">Agregar Item</span>
              </a>
            </li>
            <div id="dashboardItemsContainerOffcanvas">
              {% if dashboard_items %}
                {% for item in dashboard_items %}
                <li>
                  <a href="#dashboardItemDetailSection" class="nav-link sub-link dashboard-item-link" data-item-id="{{ item.uuid }}" data-item-name="{{ item.name }}" data-item-type="{{ item.item_type }}">
                    <i class="fa-solid fa-square-poll-vertical"></i><span class="text-label ms-1">{{ item.name }}</span>
                  </a>
                </li>
                {% endfor %}
              {% else %}
                <li>
                  <span class="text-muted ms-3">Sin items disponibles</span>
                </li>
              {% endif %}
            </div>
          </ul>
        </li>
        <!-- Pulzcards -->
        <li class="nav-item mt-2">
          <a href="#" class="nav-link sidebar-link" data-bs-toggle="collapse" data-bs-target="#pulzcardSubmenuOffcanvas" aria-expanded="false" title="Pulzcards">
            <i class="bi bi-person-badge-fill"></i><span class="text-label ms-2">Pulzcards</span>
          </a>
          <ul class="collapse list-unstyled ps-0" id="pulzcardSubmenuOffcanvas">
            <li>
              <a href="{{ url_for('pulzcard') }}" class="nav-link sub-link">
                <i class="bi bi-plus-circle-fill"></i><span class="text-label ms-1">Crear Nuevo</span>
              </a>
            </li>
            <li>
              <a href="#pulzcardsSection" class="nav-link sub-link">
                <i class="bi bi-eye-fill"></i><span class="text-label ms-1">Ver Todos</span>
              </a>
            </li>
          </ul>
        </li>
        <!-- Etiquetas -->
        <li class="nav-item mt-2">
          <a href="#" class="nav-link sidebar-link" data-bs-toggle="collapse" data-bs-target="#etiquetasSubmenuOffcanvas" aria-expanded="false" title="Etiquetas">
            <i class="bi bi-tags-fill"></i><span class="text-label ms-2">Etiquetas</span>
          </a>
          <ul class="collapse list-unstyled ps-0" id="etiquetasSubmenuOffcanvas">
            <li>
              <a href="#" data-bs-toggle="modal" data-bs-target="#agregarEtiquetaModal" class="nav-link sub-link">
                <i class="bi bi-plus-circle-fill"></i><span class="text-label ms-1">Crear Nuevo</span>
              </a>
            </li>
            <li>
              <a href="#" data-bs-toggle="modal" data-bs-target="#importTagsModal" class="nav-link sub-link" title="Importar Etiquetas">
                <i class="bi bi-file-arrow-up-fill"></i><span class="text-label ms-1">Importar</span>
              </a>
            </li>
            <li>
              <a href="#etiquetasSection" class="nav-link sub-link">
                <i class="bi bi-eye-fill"></i><span class="text-label ms-1">Ver Todos</span>
              </a>
            </li>
          </ul>
        </li>
        <!-- Bodegas -->
        <li class="nav-item mt-2">
          <a href="#" class="nav-link sidebar-link" data-bs-toggle="collapse" data-bs-target="#bodegasSubmenuOffcanvas" aria-expanded="false" title="Bodegas">
            <i class="bi bi-box-fill"></i><span class="text-label ms-2">Bodegas</span>
          </a>
          <ul class="collapse list-unstyled ps-0" id="bodegasSubmenuOffcanvas">
            <li>
              <a href="#" data-bs-toggle="modal" data-bs-target="#agregarBodegaModal" class="nav-link sub-link">
                <i class="bi bi-plus-circle-fill"></i><span class="text-label ms-1">Crear Nueva</span>
              </a>
            </li>
            <li>
              <a href="#bodegasSection" class="nav-link sub-link">
                <i class="bi bi-eye-fill"></i><span class="text-label ms-1">Ver Todas</span>
              </a>
            </li>
          </ul>
        </li>
        <hr class="my-10">
        <!-- Mi Perfil -->
        <li class="nav-item mt-2">
          <a href="#miPerfilSection" class="nav-link sidebar-link" title="Mi Perfil">
            <i class="bi bi-person-lines-fill"></i><span class="text-label ms-2">Mi Perfil</span>
          </a>
        </li>
      </ul>
    </div>
  </div>

  <!-- CONTENIDO PRINCIPAL -->
  <div class="flex-grow-1" id="mainContent" style="overflow-y: auto;">
    <!-- Sección Perfil -->
    <div id="miPerfilSection">
      <h2 class="text-center mb-4">Mi Perfil</h2>
      <div class="container-fluid mb-5">
        <div class="row">
          <div class="col-md-6">
            <h4>Información Personal</h4>
            <p><strong>Nombre de Usuario:</strong> {{ current_user.username }}</p>
            <p><strong>Correo Electrónico:</strong> {{ current_user.email }}</p>
          </div>
          <div class="col-md-6 text-end">
            <a href="{{ url_for('main.account') }}" class="btn btn-primary">Editar Perfil</a>
          </div>
        </div>
      </div>
      <hr class="my-5">
    </div>

    <!-- Sección Pulzcards -->
    <div id="pulzcardsSection" style="display:none;">
      <h4>Tus Pulzcards</h4>
      {% if pulzcards %}
      <form method="POST" action="{{ url_for('delete_bulk_pulzcards') }}" id="bulkDeletePulzcardForm">
        {{ bulk_delete_pulzcard_form.hidden_tag() }}

        <div class="action-bar-wrapper">
          <div class="action-bar">
            <button type="button"
                    class="action-btn btn-import d-flex align-items-center"
                    data-bs-toggle="modal"
                    data-bs-target="#importPulzcardModal"
                    title="Importar Pulzcards desde un archivo Excel">
              <i class="bi bi-upload"></i>
              <span class="d-none d-sm-inline ms-1">Importar</span>
            </button>
            <button type="button"
                    class="action-btn btn-export d-flex align-items-center"
                    onclick="exportSelectedPulzcards()"
                    title="Exportar Pulzcards seleccionadas">
              <i class="bi bi-download"></i>
              <span class="d-none d-sm-inline ms-1">Exportar</span>
            </button>
            <button type="button"
                    class="action-btn btn-delete d-flex align-items-center"
                    data-bs-toggle="modal"
                    data-bs-target="#confirmDeleteBulkPulzcardsModal"
                    title="Eliminar Pulzcards seleccionadas">
              <i class="bi bi-trash"></i>
              <span class="d-none d-sm-inline ms-1">Eliminar</span>
            </button>
          </div>
        </div>
        <hr class="my-10">

        <div class="table-responsive full-width">
          <table class="table table-hover custom-table table-striped table-bordered">
            <thead>
              <tr>
                <th><input type="checkbox" id="select_all_pulzcards" form="bulkDeletePulzcardForm"></th>
                <th>Nombre Tarjeta</th>
                <th>Nombre Usuario</th>
                <th>Organización</th>
                <th>Email</th>
                <th>Fecha Creación</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              {% for card in pulzcards %}
              <tr>
                <td>
                  <input type="checkbox" name="selected_pulzcards" value="{{ card.card_id }}" form="bulkDeletePulzcardForm">
                </td>
                <td>
                  {% if card.card_name|length > 15 %}
                    {{ card.card_name[:15] }}...
                  {% else %}
                    {{ card.card_name }}
                  {% endif %}
                </td>
                
                <td>
                  {% if (card.first_name ~ ' ' ~ card.last_name)|length > 15 %}
                    {{ (card.first_name ~ ' ' ~ card.last_name)[:15] }}...
                  {% else %}
                    {{ card.first_name }} {{ card.last_name }}
                  {% endif %}
                </td>
                
                <td>
                  {% if card.organization|length > 15 %}
                    {{ card.organization[:15] }}...
                  {% else %}
                    {{ card.organization }}
                  {% endif %}
                </td>
                
                <td>
                  {% if card.email|length > 20 %}
                    {{ card.email[:20] }}...
                  {% else %}
                    {{ card.email }}
                  {% endif %}
                </td>
                
                <td class="small-text">{{ card.created_at.strftime('%d/%m/%Y %H:%M') }}</td>
                <td>
                  <div class="d-none d-md-flex gap-2">
                    <a href="{{ url_for('pulzcard_card', card_id=card.card_id) }}"
                       class="btn btn-outline-secondary btn-sm" target="_blank">
                      Ver
                    </a>
                    <a href="{{ url_for('edit_pulzcard', card_id=card.card_id, next='pulzcardsSection') }}"
                       class="btn btn-outline-secondary btn-sm">
                      Editar
                    </a>
                    <a href="{{ url_for('pulzcard_qrcode', card_id=card.card_id) }}"
                       class="btn btn-outline-secondary btn-sm" title="Ver Código QR">
                      <i class="fas fa-qrcode"></i>
                    </a>
                    <form action="{{ url_for('delete_pulzcard', card_id=card.card_id) }}" method="POST" style="display:inline;">
                      {{ delete_forms[card.id].hidden_tag() }}
                      <button type="submit"
                              onclick="return confirm('¿Estás seguro de que deseas eliminar esta Pulzcard?')"
                              style="background:none; border:none; padding:0; cursor:pointer;">
                        <i class="fa-solid fa-delete-left fa-rotate-by"
                           style="color: #ff5957; --fa-rotate-angle: 0deg; font-size: 1.8em"></i>
                      </button>
                    </form>
                  </div>
                  <div class="d-md-none">
                    <div class="dropdown">
                      <button class="btn btn-outline-secondary btn-sm dropdown-toggle"
                              type="button"
                              id="dropdownMenuButtonPulz{{ card.card_id }}"
                              data-bs-toggle="dropdown" aria-expanded="false">
                        Acciones
                      </button>
                      <ul class="dropdown-menu" aria-labelledby="dropdownMenuButtonPulz{{ card.card_id }}">
                        <li>
                          <a class="dropdown-item"
                             href="{{ url_for('pulzcard_card', card_id=card.card_id) }}"
                             target="_blank">
                            <i class="fas fa-eye me-2"></i>Ver
                          </a>
                        </li>
                        <li>
                          <a class="dropdown-item"
                             href="{{ url_for('edit_pulzcard', card_id=card.card_id, next='pulzcardsSection') }}">
                            <i class="fas fa-edit me-2"></i>Editar
                          </a>
                        </li>
                        <li>
                          <a class="dropdown-item"
                             href="{{ url_for('pulzcard_qrcode', card_id=card.card_id) }}"
                             title="Ver Código QR">
                            <i class="fas fa-qrcode me-2"></i>Ver QR
                          </a>
                        </li>
                        <li>
                          <form action="{{ url_for('delete_pulzcard', card_id=card.card_id) }}" method="POST" style="display:inline;">
                            {{ delete_forms[card.id].hidden_tag() }}
                            <button type="submit"
                                    onclick="return confirm('¿Estás seguro de que deseas eliminar esta Pulzcard?')"
                                    class="dropdown-item bg-danger text-white">
                              <i class="fa-regular fa-eraser me-2"></i>Eliminar
                            </button>
                          </form>
                        </li>
                      </ul>
                    </div>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </form>

      <div class="modal fade" id="confirmDeleteBulkPulzcardsModal" tabindex="-1" aria-labelledby="confirmDeleteBulkPulzcardsModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="confirmDeleteBulkPulzcardsModalLabel">Confirmar Eliminación</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
              <p>¿Estás seguro de que deseas eliminar las Pulzcards seleccionadas? Esta acción no se puede deshacer.</p>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
              <button type="button" class="btn btn-danger" id="confirmDeleteBulkPulzcardsBtn">Eliminar</button>
            </div>
          </div>
        </div>
      </div>
      {% else %}
      <p>No has creado ninguna Pulzcard aún. <a href="{{ url_for('pulzcard') }}">Crear una Pulzcard</a>.</p>
      {% endif %}
      <div class="mt-3">
        <a href="{{ url_for('pulzcard') }}" class="btn btn-secondary">
          <i class="fas fa-user-plus" style="color: rgb(104, 245, 167); font-size: 1.0em;"></i> Añadir
        </a>
      </div>
      <hr class="my-5">
    </div>

    <!-- Etiquetas -->
    <div id="etiquetasSection" style="display:none;">
      <h4>Tus Etiquetas y QR Code</h4>
      {% if tags %}
      <form method="POST" action="{{ url_for('delete_bulk_tags') }}" id="bulkDeleteForm">
        {{ bulk_delete_tag_form.hidden_tag() }}
        <div class="action-bar-wrapper">
          <div class="action-bar">
            <button type="button"
                    class="action-btn btn-import d-flex align-items-center"
                    data-bs-toggle="modal"
                    data-bs-target="#importTagsModal"
                    title="Importar etiquetas desde un archivo">
              <i class="bi bi-upload"></i>
              <span class="d-none d-sm-inline ms-1">Importar</span>
            </button>
            <button type="button"
                    class="action-btn btn-export d-flex align-items-center"
                    onclick="exportSelectedTags()"
                    title="Exportar etiquetas seleccionadas">
              <i class="bi bi-download"></i>
              <span class="d-none d-sm-inline ms-1">Exportar</span>
            </button>
            <button type="button"
                    class="action-btn btn-delete d-flex align-items-center"
                    data-bs-toggle="modal"
                    data-bs-target="#confirmDeleteBulkModal"
                    title="Eliminar etiquetas seleccionadas">
              <i class="bi bi-trash"></i>
              <span class="d-none d-sm-inline ms-1">Eliminar</span>
            </button>
          </div>
        </div>
        <hr class="my-10">

        <!-- Resto del contenido de Etiquetas -->
        <div class="table-responsive full-width">
          <table class="table table-hover custom-table table-striped table-bordered">
            <thead>
              <tr>
                <th><input type="checkbox" id="select_all" form="bulkDeleteForm"></th>
                <th>Nombre Etiqueta</th>
                <th>URL destino</th>
                <th>URL enlace</th>
                <th>Vistas</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              {% for tag in tags %}
              <tr>
                <td>
                  <input type="checkbox" name="selected_tags" value="{{ tag.tag_id }}" form="bulkDeleteForm">
                <td>
                  {% if tag.tag_name|length > 25 %}
                    {{ tag.tag_name[:25] }}...
                  {% else %}
                    {{ tag.tag_name }}
                  {% endif %}
                </td>
                <td>
                  <a href="{{ tag.redirect_url }}" target="_blank">
                    {% if tag.redirect_url|length > 25 %}
                      {{ tag.redirect_url[:25] }}...
                    {% else %}
                      {{ tag.redirect_url }}
                    {% endif %}
                  </a>
                </td>
                <td>
                  {% set generated_url = url_for('redirect_tag', tag_id=tag.tag_id, _external=True) %}
                  <a href="{{ generated_url }}" target="_blank">
                    {% if generated_url|length > 25 %}
                      {{ generated_url[:25] }}...
                    {% else %}
                      {{ generated_url }}
                    {% endif %}
                  </a>
                </td>
                <td>{{ tag.vistas }}</td>
                <td>
                  <div class="d-none d-md-flex gap-2">
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="copyURL('{{ generated_url }}')">Copiar</button>
                    <a href="{{ url_for('edit_tag', tag_id=tag.tag_id, next='etiquetasSection') }}" class="btn btn-outline-secondary btn-sm">Editar</a>
                    <a href="{{ url_for('tag_qrcode', tag_id=tag.tag_id) }}" class="btn btn-outline-secondary btn-sm" title="Ver Código QR">
                      <i class="fas fa-qrcode"></i>
                    </a>
                    <form action="{{ url_for('delete_tag', tag_id=tag.tag_id) }}" method="POST" style="display:inline;">
                      {{ delete_tag_forms[tag.id].hidden_tag() }}
                      <button type="submit"
                              onclick="return confirm('¿Estás seguro de que deseas eliminar esta etiqueta?')"
                              style="background:none; border:none; padding:0; cursor:pointer;">
                        <i class="fa-solid fa-delete-left fa-rotate-by" style="color: #ff5957; --fa-rotate-angle: 0deg; font-size: 1.8em"></i>
                      </button>
                    </form>
                  </div>
                  <div class="d-md-none">
                    <div class="dropdown">
                      <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" id="dropdownMenuButtonTag{{ tag.tag_id }}" data-bs-toggle="dropdown" aria-expanded="false">
                        Acciones
                      </button>
                      <ul class="dropdown-menu" aria-labelledby="dropdownMenuButtonTag{{ tag.tag_id }}">
                        <li>
                          <a href="#" class="dropdown-item"
                            onclick="copyURL('{{ generated_url }}'); return false;">
                            <i class="fas fa-copy me-2"></i>Copiar URL
                          </a>
                        </li>
                        <li>
                          <a class="dropdown-item" href="{{ url_for('edit_tag', tag_id=tag.tag_id, next='etiquetasSection') }}">
                            <i class="fas fa-edit me-2"></i>Editar
                          </a>
                        </li>
                        <li>
                          <a class="dropdown-item" href="{{ url_for('tag_qrcode', tag_id=tag.tag_id) }}" title="Ver Código QR">
                            <i class="fas fa-qrcode me-2"></i>Ver QR
                          </a>
                        </li>
                        <li>
                          <form action="{{ url_for('delete_tag', tag_id=tag.tag_id) }}" method="POST" style="display:inline;">
                            {{ delete_tag_forms[tag.id].hidden_tag() }}
                            <button type="submit"
                                    onclick="return confirm('¿Estás seguro de que deseas eliminar esta etiqueta?')"
                                    class="dropdown-item bg-danger text-white">
                              <i class="fa-regular fa-eraser me-2"></i>Eliminar
                            </button>
                          </form>
                        </li>
                      </ul>
                    </div>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <p>No has creado ninguna etiqueta aún.
          <a href="#" class="text-decoration-underline" data-bs-toggle="modal" data-bs-target="#agregarEtiquetaModal">Crear una Etiqueta</a>.
        </p>
        {% endif %}
        <div class="mt-3">
          <button type="button" class="btn btn-secondary d-flex align-items-center" data-bs-toggle="modal" data-bs-target="#agregarEtiquetaModal">
            <i class="fa-regular fa-square-plus" style="color: rgb(104, 245, 167); font-size: 1.0em;"></i>
            <span class="d-none d-sm-inline ms-1">Añadir</span>
          </button>
        </div>
        <hr class="my-5">
    </div>

    <!-- BODEGAS -->
    <div id="bodegasSection" style="display:none;">
      <h4>Bodegas</h4>
      {% if bodegas %}
      <div class="table-responsive full-width">
        <table class="table table-hover custom-table">
          <thead>
            <tr>
              <th>ID Bodega</th>
              <th>Nombre</th>
              <th>Fecha de Creación</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for bodega in bodegas %}
            <tr>
              <td>
                <a href="{{ url_for('view_bodega', uuid_bodega=bodega.uuid) }}">
                  {{ bodega.id_bodega }}
                </a>
              </td>
              <td>{{ bodega.nombre }}</td>
              <td>{{ bodega.fecha_creacion.strftime('%d/%m/%Y %H:%M') }}</td>
              <td>
                <div class="d-none d-md-flex gap-2">
                  <a href="{{ url_for('bodega_qrcode', uuid_bodega=bodega.uuid) }}"
                     class="btn btn-outline-secondary btn-sm" title="Ver Código QR">
                    <i class="fas fa-qrcode"></i>
                  </a>
                  <a href="{{ url_for('edit_bodega', uuid_bodega=bodega.uuid, next='bodegasSection') }}"
                     class="btn btn-outline-secondary btn-sm">Editar</a>
                  <form action="{{ url_for('delete_bodega', uuid_bodega=bodega.uuid) }}"
                        method="POST" style="display:inline;">
                    {{ delete_bodega_forms[bodega.uuid].hidden_tag() }}
                    <button type="submit"
                            onclick="return confirm('¿Estás seguro de que deseas eliminar esta bodega?')"
                            style="background:none; border:none; padding:0; cursor:pointer;">
                      <i class="fa-solid fa-delete-left fa-rotate-by" style="color: #ff5957; --fa-rotate-angle: 0deg; font-size: 1.8em"></i>
                    </button>
                  </form>
                </div>
                <div class="d-md-none">
                  <div class="dropdown">
                    <button class="btn btn-outline-secondary btn-sm dropdown-toggle"
                            type="button" id="dropdownMenuButtonBodega{{ bodega.uuid }}"
                            data-bs-toggle="dropdown" aria-expanded="false">
                      Acciones
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="dropdownMenuButtonBodega{{ bodega.uuid }}">
                      <li>
                        <a href="{{ url_for('bodega_qrcode', uuid_bodega=bodega.uuid) }}" class="dropdown-item" title="Ver Código QR">
                          <i class="fas fa-qrcode me-2"></i>Ver QR
                        </a>
                      </li>
                      <li>
                        <a class="dropdown-item" href="{{ url_for('edit_bodega', uuid_bodega=bodega.uuid, next='bodegasSection') }}">
                          <i class="fas fa-edit me-2"></i>Editar
                        </a>
                      </li>
                      <li>
                        <form action="{{ url_for('delete_bodega', uuid_bodega=bodega.uuid) }}" method="POST" style="display:inline;">
                          {{ delete_bodega_forms[bodega.uuid].hidden_tag() }}
                          <button type="submit"
                                  onclick="return confirm('¿Estás seguro de que deseas eliminar esta bodega?')"
                                  class="dropdown-item bg-danger text-white">
                            <i class="fa-regular fa-eraser me-2"></i>Eliminar
                          </button>
                        </form>
                      </li>
                    </ul>
                  </div>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <p>No has creado ninguna bodega aún.
        <a href="#" class="text-decoration-underline" data-bs-toggle="modal" data-bs-target="#agregarBodegaModal">Crear una Bodega</a>.
      </p>
      {% endif %}
      <div class="mt-3">
        <button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#agregarBodegaModal">
          <i class="fa-regular fa-square-plus" style="color: rgb(104, 245, 167); font-size: 1.0em;"></i> Añadir
        </button>
      </div>
    </div>

    <!-- Sección Detalle de Ítem del Dashboard -->
    <div id="dashboardItemDetailSection" style="display:none;">
      <div class="mb-3 text-start">
        <small class="text-muted">
          <strong>Nombre de ítem:</strong>
          <span id="dashboardItemName"></span>
          &nbsp;&nbsp;&nbsp;
          <strong>Tipo de Ítem:</strong>
          <span id="dashboardItemType"></span>
        </small>
      </div>
      <!-- Resto del contenido (botones, gráficas, etc.) -->
      <div class="dashboard-section flex-right" id="dashboardItemActions">
        <div class="action-bar-wrapper">
          <div class="action-bar">
            <a class="btn btn-sm btn-primary action-btn d-flex align-items-center" id="surveyLink" title="Responder" target="_blank">
              <i class="fa-solid fa-reply"></i>
              <span class="d-none d-sm-inline ms-1">Responder</span>
            </a>
            <button class="btn btn-sm btn-primary action-btn d-flex align-items-center" id="fullscreenToggleBtn" title="Ver en Pantalla Completa">
              <i class="fa-solid fa-expand"></i>
              <span class="d-none d-sm-inline ms-1">Pantalla Completa</span>
            </button>
            <button class="btn btn-sm btn-primary action-btn d-flex align-items-center" id="copySurveyBtn" title="Copiar URL">
              <i class="fa-solid fa-clone"></i>
              <span class="d-none d-sm-inline ms-1">Copiar URL</span>
            </button>
            <button class="btn btn-sm btn-primary action-btn d-flex align-items-center" id="showSurveyQRBtn" title="Ver QR">
              <i class="fas fa-qrcode"></i>
              <span class="d-none d-sm-inline ms-1">QR</span>
            </button>
            <button class="btn btn-sm btn-primary action-btn d-flex align-items-center" id="downloadChartBtn" title="Descargar Gráfico">
              <i class="fa-solid fa-download"></i>
              <span class="d-none d-sm-inline ms-1">Descargar Gráfico</span>
            </button>
            <button class="btn btn-sm btn-danger action-btn d-flex align-items-center" id="eliminarItemBtn" title="Eliminar">
              <i class="fa-solid fa-trash"></i>
              <span class="d-none d-sm-inline ms-1">Eliminar</span>
            </button>
          </div>
        </div>
      </div>
      <!-- Modal Pantalla Completa -->
      <div class="modal fade" id="fullscreenModal" tabindex="-1" aria-labelledby="fullscreenModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="fullscreenModalLabel">Vista Completa</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body d-flex justify-content-center align-items-center">
              <div id="fullscreenContent" class="w-100 h-100"></div>
            </div>
          </div>
        </div>
      </div>

      <div id="dashboardItemStats" style="display:none;">
        <div class="mb-3 d-flex flex-nowrap justify-content-end align-items-center gap-2">
          <label for="dateRangePicker" class="form-label mb-0"></label>
          <input type="date" id="startDate" class="form-control form-control-sm" style="width: auto;">
          <span>a</span>
          <input type="date" id="endDate" class="form-control form-control-sm" style="width: auto;">
          <button class="btn btn-sm btn-primary action-btn d-flex align-items-center" id="filterDateBtn"><i class="bi bi-list"></i> Filtrar</button>
        </div>
        <div class="d-flex justify-content-end align-items-center mb-3">
          <select id="chartIndicatorSelect" class="form-select form-select-sm" style="width: 220px;">
            <option value="count" selected>Cantidad de Evaluaciones</option>
            <option value="average">Promedio de Puntajes</option>
            <option value="nps">NPS Ponderado</option>
            <option value="csat">CSAT (Satisfacción del Cliente)</option>
            <option value="ces">CES (Esfuerzo del Cliente)</option>
            <option value="response_rate">Tasa de Respuesta</option>
            <option value="sentiment">Análisis de Sentimientos</option>
            <option value="stacked">Gráfico Barras Apiladas</option>
            <option value="table">Tabla de Evaluaciones</option>
          </select>
        </div>
        <div id="chartContainer" class="full-width">
          <div id="chartWrapper">
            <canvas id="myChart"></canvas>
          </div>
        </div>
        <div id="tableContainer" style="display:none;">
          <table class="table table-bordered table-striped table-hover text-center" id="ratingsTable">
            <thead class="table-info">
              <tr id="ratingsHeader">
                <th>Valoración</th>
              </tr>
            </thead>
            <tbody>
              <tr id="rating10Row"><th>10</th></tr>
              <tr id="rating9Row"><th>9</th></tr>
              <tr id="rating8Row"><th>8</th></tr>
              <tr id="rating7Row"><th>7</th></tr>
              <tr id="rating6Row"><th>6</th></tr>
              <tr id="rating5Row"><th>5</th></tr>
              <tr id="rating4Row"><th>4</th></tr>
              <tr id="rating3Row"><th>3</th></tr>
              <tr id="rating2Row"><th>2</th></tr>
              <tr id="rating1Row"><th>1</th></tr>
              <tr id="totalRow"><th>Total</th></tr>
            </tbody>
          </table>
        </div>
        <div id="dayDetailsContainer" style="display:none; margin-top: 20px;">
          <h5 id="detailsTitle"></h5>
          <table class="table table-bordered table-striped table-hover text-center">
            <thead class="table-info">
              <tr>
                <th>Evaluación (1 a 10)</th>
                <th>Comentario</th>
              </tr>
            </thead>
            <tbody id="dayDetailsBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- Indicador de carga personalizado -->
<div id="loader" class="d-none" style="
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255,255,255,0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
">
  <img src="/static/images/logochain1.png" alt="Logo" class="pulsate" style="width: 50px; height: auto; margin-right: 10px;">
  <div style="font-size: 1.5rem; color: #333;">
    Cargando<span id="dots"></span>
  </div>
</div>
<!-- MODALES para Pulzcards, Etiquetas, Bodegas, Dashboard Items -->
<!-- Modal Importar Pulzcards -->
<div class="modal fade" id="importPulzcardModal" tabindex="-1" aria-labelledby="importPulzcardModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="POST" action="{{ url_for('import_pulzcards') }}" enctype="multipart/form-data">
        {{ import_pulzcards_form.hidden_tag() }}
        <div class="modal-header">
          <h5 class="modal-title" id="importPulzcardModalLabel">Importar Pulzcards desde Excel</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <p><strong>Cómo Importar:</strong></p>
          <p>Asegúrate de que tu archivo Excel tenga al menos las columnas:</p>
          <table class="table table-bordered">
            <thead>
              <tr>
                {% for field in pulzcard_fields %}
                <th>{{ field }}</th>
                {% endfor %}
              </tr>
            </thead>
            <tbody>
              <tr>
                {% for _ in pulzcard_fields %}
                <td>Ejemplo</td>
                {% endfor %}
              </tr>
            </tbody>
          </table>
          <div class="mb-3">
            <label for="excelFilePulzcards" class="form-label">Selecciona tu archivo Excel</label>
            {{ import_pulzcards_form.excelFile(class="form-control", id="excelFilePulzcards", required=True) }}
            {% for error in import_pulzcards_form.excelFile.errors %}
            <div class="text-danger">{{ error }}</div>
            {% endfor %}
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
          {{ import_pulzcards_form.submit(class="btn btn-primary") }}
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal Agregar Etiqueta -->
<div class="modal fade" id="agregarEtiquetaModal" tabindex="-1" aria-labelledby="agregarEtiquetaModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="POST" action="{{ url_for('create_tag') }}">
        {{ tag_form.hidden_tag() }}
        <div class="modal-header">
          <h5 class="modal-title" id="agregarEtiquetaModalLabel">Agregar Nueva Etiqueta</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            {{ tag_form.tag_name.label(class="form-label") }}
            {{ tag_form.tag_name(class="form-control", placeholder="Nombre de la Etiqueta") }}
            {% for error in tag_form.tag_name.errors %}
            <div class="text-danger">{{ error }}</div>
            {% endfor %}
          </div>
          <div class="mb-3">
            {{ tag_form.redirect_url.label(class="form-label") }}
            {{ tag_form.redirect_url(class="form-control", placeholder="URL de Redirección") }}
            {% for error in tag_form.redirect_url.errors %}
            <div class="text-danger">{{ error }}</div>
            {% endfor %}
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          {{ tag_form.submit(class="btn btn-success") }}
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal Importar Etiquetas -->
<div class="modal fade" id="importTagsModal" tabindex="-1" aria-labelledby="importTagsModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="POST" action="{{ url_for('import_tags') }}" enctype="multipart/form-data">
        {{ import_tags_form.hidden_tag() }}
        <div class="modal-header">
          <h5 class="modal-title" id="importTagsModalLabel">Importar Etiquetas desde Excel</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <p><strong>Cómo Importar:</strong></p>
          <p>Asegúrate de que tu archivo Excel tenga las columnas:</p>
          <table class="table table-bordered">
            <thead>
              <tr>
                {% for field in tag_fields %}
                <th>{{ field }}</th>
                {% endfor %}
              </tr>
            </thead>
            <tbody>
              <tr>
                {% for _ in tag_fields %}
                <td>Ejemplo de dato</td>
                {% endfor %}
              </tr>
            </tbody>
          </table>
          <div class="mb-3">
            <label for="excelFile" class="form-label">Selecciona tu archivo Excel</label>
            {{ import_tags_form.excelFile(class="form-control", id="excelFile", required=True) }}
            {% for error in import_tags_form.excelFile.errors %}
            <div class="text-danger">{{ error }}</div>
            {% endfor %}
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
          {{ import_tags_form.submit(class="btn btn-primary") }}
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal Agregar Bodega -->
<div class="modal fade" id="agregarBodegaModal" tabindex="-1" aria-labelledby="agregarBodegaModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="POST" action="{{ url_for('create_bodega') }}">
        {{ bodega_form.hidden_tag() }}
        <div class="modal-header">
          <h5 class="modal-title" id="agregarBodegaModalLabel">Agregar Nueva Bodega</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            {{ bodega_form.nombre.label(class="form-label") }}
            {{ bodega_form.nombre(class="form-control", placeholder="Nombre de la Bodega") }}
            {% for error in bodega_form.nombre.errors %}
            <div class="text-danger">{{ error }}</div>
            {% endfor %}
          </div>
          <div class="mb-3">
            {{ bodega_form.ubicacion.label(class="form-label") }}
            {{ bodega_form.ubicacion(class="form-control", placeholder="Ubicación") }}
            {% for error in bodega_form.ubicacion.errors %}
            <div class="text-danger">{{ error }}</div>
            {% endfor %}
          </div>
          <div class="mb-3">
            {{ bodega_form.notas.label(class="form-label") }}
            {{ bodega_form.notas(class="form-control", placeholder="Notas") }}
            {% for error in bodega_form.notas.errors %}
            <div class="text-danger">{{ error }}</div>
            {% endfor %}
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          {{ bodega_form.submit(class="btn btn-success") }}
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal Agregar Item Dashboard -->
<div class="modal fade" id="agregarItemModal" tabindex="-1" aria-labelledby="agregarItemModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="agregarItemForm">
        <div class="modal-header">
          <h5 class="modal-title" id="agregarItemModalLabel">Agregar Nuevo Item al Dashboard</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="itemNameInput" class="form-label">Nombre del Item</label>
            <input type="text" class="form-control" id="itemNameInput" name="name" required>
          </div>
          <div class="mb-3">
            <label for="itemTypeSelect" class="form-label">Tipo de Item</label>
            <select class="form-select" id="itemTypeSelect" name="item_type" required>
              <option value="" selected disabled>Selecciona un tipo</option>
              <option value="Evaluación de Clientes">Evaluación de Clientes (NPS 1-10)</option>
              <option value="Evaluación de Semáforo">Evaluación de Semáforo (1-3)</option>
              <option value="Visualizaciones diarias">Visualizaciones Diarias</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-success">Agregar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal Eliminar Item Dashboard -->
<div class="modal fade" id="confirmDeleteDashboardItemModal" tabindex="-1" aria-labelledby="confirmDeleteDashboardItemModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="deleteDashboardItemForm">
        <div class="modal-header">
          <h5 class="modal-title" id="confirmDeleteDashboardItemModalLabel">Confirmar Eliminación</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <p>¿Estás seguro de que deseas eliminar este ítem del Dashboard? Esta acción no se puede deshacer.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-danger">Eliminar</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% if bodega_form.errors %}
<script>
  var agregarBodegaModal = new bootstrap.Modal(document.getElementById('agregarBodegaModal'));
  agregarBodegaModal.show();
</script>
{% endif %}

{% if tag_form.errors %}
<script>
  var agregarEtiquetaModal = new bootstrap.Modal(document.getElementById('agregarEtiquetaModal'));
  agregarEtiquetaModal.show();
</script>
{% endif %}
{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<!-- Asegúrate de incluir FontAwesome para los íconos (sort y filter) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
<script>
  // Funciones para mostrar y ocultar el loader
  function showLoader() {
    document.getElementById('loader').classList.remove('d-none');
  }
  function hideLoader() {
    document.getElementById('loader').classList.add('d-none');
  }

  // ----------------------------------------------------------------------------------
  // Variables globales:
  // - globalRatingsData, globalDates y globalDetails se usan para el gráfico.
  // - window.trendMethod define el método actual de tendencia (por defecto "lineal").
  // - trendLineDataset se usa para almacenar el dataset de tendencia en el gráfico.
  let trendLineDataset = null;
  window.trendMethod = "lineal";  // por defecto

  // ----------------------------------------------------------------------------------
  // Al cargar el DOM
  $(document).ready(function() {
    // 1) Inicializa DataTables en todas las tablas con la clase .custom-table
    $('.custom-table').DataTable({
      language: {
        url: "https://cdn.datatables.net/plug-ins/1.11.5/i18n/es-ES.json"
      }
    });

    // 2) Control de secciones mediante el hash de la URL
    function showSection(section) {
      var sections = [
        'miPerfilSection',
        'pulzcardsSection',
        'etiquetasSection',
        'bodegasSection',
        'dashboardItemDetailSection'
      ];
      sections.forEach(function(sec) {
        var el = document.getElementById(sec);
        if (el) {
          el.style.display = (sec === section) ? 'block' : 'none';
        }
      });
    }
    function handleHash() {
      var hash = window.location.hash.substring(1);
      if (hash) {
        showSection(hash);
      } else {
        showSection('miPerfilSection');
      }
    }
    window.addEventListener('load', handleHash, false);
    window.addEventListener('hashchange', handleHash, false);

    // 2.1) Listener delegado para cerrar el off-canvas automáticamente al pulsar enlaces
    $('#offcanvasSidebar').on('click', 'a', function(e) {
      var href = $(this).attr('href');
      if ($(this).attr('data-bs-toggle') === 'collapse') {
        return;
      }
      if (href && href.startsWith('#')) {
        if (location.hash === href) {
          handleHash();
        } else {
          location.hash = href;
        }
      }
      var offcanvasElement = document.getElementById('offcanvasSidebar');
      if (offcanvasElement) {
        var offcanvasInstance = bootstrap.Offcanvas.getInstance(offcanvasElement);
        if (offcanvasInstance) {
          offcanvasInstance.hide();
        }
      }
    });

    // 3) Función para manejar el clic en los ítems del Dashboard
    function handleDashboardItemClick(e, element) {
      e.preventDefault();
      var name = $(element).data('item-name');
      var type = $(element).data('item-type');
      var itemId = $(element).data('item-id');

      $('#dashboardItemName').text(name);
      $('#dashboardItemType').text(type);
      $('#eliminarItemBtn').data('item-id', itemId);

      if (["Evaluación de Clientes", "Evaluación de Semáforo", "CSAT", "CES", "Sentiment", "Response Rate"].includes(type)) {
        var surveyUrl = "{{ url_for('survey', item_uuid='ITEMUUID', _external=True) }}".replace('ITEMUUID', itemId);
        $('#surveyLink')
          .attr('href', surveyUrl)
          .show()
          .find('span')
          .text('Responder');
        $('#copySurveyBtn').off('click').on('click', function() {
          navigator.clipboard.writeText(surveyUrl)
            .then(function(){ alert('URL copiada al portapapeles!'); })
            .catch(function(err){ alert('Error al copiar la URL: ' + err); });
        }).show();
        $('#showSurveyQRBtn').off('click').on('click', function() {
          window.open('/survey_qrcode/' + itemId, '_blank');
        }).show();
        $('#dashboardItemStats').show();
        renderLast10DaysTable(itemId, type);
      } else {
        $('#surveyLink, #copySurveyBtn, #showSurveyQRBtn').hide();
        $('#dashboardItemStats').hide();
      }
      showSection('dashboardItemDetailSection');
    }

    // Listeners para ítems en sidebar y off-canvas
    $('#dashboardItemsContainer').on('click', '.dashboard-item-link', function(e) {
      handleDashboardItemClick(e, this);
    });
    $('#dashboardItemsContainerOffcanvas').on('click', '.dashboard-item-link', function(e) {
      handleDashboardItemClick(e, this);
    });

    // 4) Función para copiar URL al portapapeles
    window.copyURL = function(url) {
      navigator.clipboard.writeText(url)
        .then(function(){ alert('URL copiada al portapapeles!'); })
        .catch(function(err){ alert('Error al copiar URL: ' + err); });
    };

    // 5) Toggle del sidebar
    var sidebar = document.getElementById('sidebar');
    var toggleBtn = document.getElementById('sidebarToggle');
    if (sidebar && toggleBtn) {
      toggleBtn.addEventListener('click', function() {
        sidebar.classList.toggle('collapsed');
        this.innerHTML = sidebar.classList.contains('collapsed')
          ? '<i class="bi bi-chevron-right"></i>'
          : '<i class="bi bi-chevron-left"></i>';
      });
    }

    // 6) Selección masiva de Etiquetas
    var selectAllTagsCheckbox = document.getElementById('select_all');
    if (selectAllTagsCheckbox) {
      selectAllTagsCheckbox.addEventListener('click', function() {
        var checkboxes = document.querySelectorAll('input[name="selected_tags"]');
        checkboxes.forEach(ch => { ch.checked = selectAllTagsCheckbox.checked; });
      });
    }
    var confirmDeleteBulkBtn = document.getElementById('confirmDeleteBulkBtn');
    if (confirmDeleteBulkBtn) {
      confirmDeleteBulkBtn.addEventListener('click', function(){
        document.getElementById('bulkDeleteForm').submit();
      });
    }

    // 7) Exportar Etiquetas
    window.exportSelectedTags = function() {
      var selectedTags = document.querySelectorAll('input[name="selected_tags"]:checked');
      if (!selectedTags.length) {
        alert('Selecciona al menos una etiqueta para exportar.');
        return;
      }
      var tagIds = Array.from(selectedTags).map(tag => tag.value);
      fetch('{{ url_for("export_tags") }}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token() }}' },
        body: JSON.stringify({ tag_ids: tagIds })
      })
      .then(res => {
        if (!res.ok) {
          return res.json().then(data => { throw new Error(data.error); });
        }
        return res.blob();
      })
      .then(blob => {
        var url = window.URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = 'tags_export.xlsx';
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
      })
      .catch(err => {
        console.error('Error:', err);
        alert('Error exportando: ' + err.message);
      });
    };

    // 8) Selección masiva de Pulzcards
    var selectAllPulzcardsCheckbox = document.getElementById('select_all_pulzcards');
    if (selectAllPulzcardsCheckbox) {
      selectAllPulzcardsCheckbox.addEventListener('click', function(){
        var checkboxes = document.querySelectorAll('input[name="selected_pulzcards"]');
        checkboxes.forEach(ch => { ch.checked = selectAllPulzcardsCheckbox.checked; });
      });
    }
    var confirmDeleteBulkPulzcardsBtn = document.getElementById('confirmDeleteBulkPulzcardsBtn');
    if (confirmDeleteBulkPulzcardsBtn) {
      confirmDeleteBulkPulzcardsBtn.addEventListener('click', function(){
        document.getElementById('bulkDeletePulzcardForm').submit();
      });
    }

    // 9) Exportar Pulzcards
    window.exportSelectedPulzcards = function() {
      var selected = document.querySelectorAll('input[name="selected_pulzcards"]:checked');
      if (!selected.length) {
        alert('Selecciona al menos una Pulzcard para exportar.');
        return;
      }
      var pulz_ids = Array.from(selected).map(el => el.value);
      fetch('{{ url_for("export_pulzcards") }}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token() }}' },
        body: JSON.stringify({ pulz_ids: pulz_ids })
      })
      .then(res => {
        if(!res.ok) {
          return res.json().then(data=>{throw new Error(data.error);});
        }
        return res.blob();
      })
      .then(blob => {
        var url = window.URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = 'pulzcards_export.xlsx';
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
      })
      .catch(err => {
        console.error('Error:', err);
        alert('Error exportando pulzcards: ' + err.message);
      });
    };

    // 10) Crear Item Dashboard (Ajax)
    $('#agregarItemForm').submit(function(e) {
      e.preventDefault();
      var itemName = $('#itemNameInput').val().trim();
      var itemType = $('#itemTypeSelect').val();
      if (!itemName || !itemType) {
        alert('Completa todos los campos.');
        return;
      }
      $.ajax({
        url: "{{ url_for('create_dashboard_item') }}",
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ name: itemName, item_type: itemType }),
        headers: { 'X-CSRFToken': '{{ csrf_token() }}' },
        success: function(resp) {
          var newItemHtml = '<li>' +
              '<a href="#dashboardItemDetailSection" class="nav-link sub-link dashboard-item-link" ' +
              'data-item-id="'+ resp.uuid +'" data-item-name="'+ itemName +'" data-item-type="'+ itemType +'">' +
              '<i class="fa-solid fa-square-poll-vertical"></i>' +
              '<span class="text-label ms-1">' + itemName + '</span>' +
              '</a></li>';
          $('#dashboardItemsContainer').append(newItemHtml);
          $('#dashboardItemsContainerOffcanvas').append(newItemHtml);
          $('#agregarItemModal').modal('hide');
          $('#itemNameInput').val('');
          $('#itemTypeSelect').val('');
          var $newItemLink = $('#dashboardItemsContainer .dashboard-item-link').last();
          if ($newItemLink.length) {
            $newItemLink.trigger('click');
          } else {
            location.hash = '#dashboardItemDetailSection';
          }
        },
        error: function() {
          alert('Error al crear ítem.');
        }
      });
    });

    // 11) Renderizar tabla y gráfico
    var globalRatingsData = null, globalDates = null, globalDetails = null;

    function renderLast10DaysTable(itemUUID, itemType){
      var ratingsHeader = document.getElementById('ratingsHeader');
      Array.from(ratingsHeader.querySelectorAll('th:not(:first-child)')).forEach(th => th.remove());
      var rowIds = ['rating10Row','rating9Row','rating8Row','rating7Row','rating6Row','rating5Row','rating4Row','rating3Row','rating2Row','rating1Row','totalRow'];
      rowIds.forEach(function(rowId){
        var row = document.getElementById(rowId);
        while(row.children.length > 1){
          row.removeChild(row.lastChild);
        }
      });

      showLoader(); // Mostrar indicador de carga

      $.ajax({
        url:'{{ url_for("get_ratings_data") }}',
        type:'GET',
        data:{
          item_uuid: itemUUID,
          start_date: $('#startDate').val(),
          end_date: $('#endDate').val()
        },
        success:function(resp){
          hideLoader(); // Ocultar indicador de carga
          if(resp.error){
            console.error("Error:", resp.error);
            return;
          }
          globalRatingsData = resp.ratings;
          globalDates = resp.dates;
          globalDetails = resp.details;

          globalDates.forEach(function(dateStr){
            var th = document.createElement('th');
            th.textContent = dateStr;
            ratingsHeader.appendChild(th);
          });
          fillTableWithCounts(globalRatingsData);
          renderChart(globalRatingsData, globalDates, globalDetails, itemType, 'count');
          // La función renderChart se encargará de agregar la línea de tendencia.
        },
        error:function(xhr, status, error){
          hideLoader();
          console.error('Error al obtener datos:', error);
        }
      });
    }

    function fillTableWithCounts(ratingsData){
      for(var val = 10; val >= 1; val--){
        var row = document.getElementById('rating' + val + 'Row');
        var countArray = ratingsData[val.toString()] || [];
        countArray.forEach(function(cnt){
          var td = document.createElement('td');
          td.textContent = cnt;
          row.appendChild(td);
        });
      }
      var totalRow = document.getElementById('totalRow');
      var length = (ratingsData["1"] || []).length;
      var dayTotals = new Array(length).fill(0);
      for(var rating = 1; rating <= 10; rating++){
        var arr = ratingsData[rating.toString()] || [];
        arr.forEach(function(cnt, i){
          dayTotals[i] += cnt;
        });
      }
      dayTotals.forEach(function(t){
        var td = document.createElement('td');
        td.textContent = t;
        totalRow.appendChild(td);
      });
    }

    // Cálculo de indicadores
    function computeDataByIndicator(ratingsData, dates, indicator){
      var length = dates.length;
      var resultArray = new Array(length).fill(0);

      for(var i = 0; i < length; i++){
        var total = 0, sumRatings = 0, promoters = 0, passives = 0, detractors = 0;
        for(var rating = 1; rating <= 10; rating++){
          var c = (ratingsData[rating.toString()] || [])[i] || 0;
          total += c;
          sumRatings += rating * c;
          if(rating >= 9) promoters += c;
          else if(rating >= 7) passives += c;
          else detractors += c;
        }

        if(indicator === "csat"){
          var csat = 0;
          if(total > 0) csat = (promoters / total) * 100;
          resultArray[i] = csat;
        }
        else if(indicator === "ces"){
          var sumEsfuerzo = 0; 
          var totEsf = 0;
          for(var r = 1; r <= 5; r++){
            var c2 = (ratingsData[r.toString()] || [])[i] || 0;
            sumEsfuerzo += r * c2;
            totEsf += c2;
          }
          resultArray[i] = totEsf > 0 ? sumEsfuerzo / totEsf : 0;
        }
        else if(indicator === "response_rate"){
          var totalSent = 0; 
          if(globalRatingsData && globalRatingsData.total_sent){
            totalSent = globalRatingsData.total_sent[i] || 0;
          }
          resultArray[i] = totalSent > 0 ? (total / totalSent) * 100 : 0;
        }
        else if(indicator === "sentiment"){
          var sentiments = globalDetails[dates[i]] || [];
          var sentimentSum = 0, sentimentCount = 0;
          sentiments.forEach(function(resp){
            if(resp.sentiment !== undefined){
              sentimentSum += resp.sentiment;
              sentimentCount++;
            }
          });
          resultArray[i] = sentimentCount > 0 ? sentimentSum / sentimentCount : 0;
        }
        else {
          switch(indicator){
            case "count":
              resultArray[i] = total;
              break;
            case "average":
              resultArray[i] = total > 0 ? (sumRatings / total) : 0;
              break;
            case "nps":
              resultArray[i] = total > 0 ? ((promoters - detractors) / total) * 100 : 0;
              break;
            default:
              resultArray[i] = 0;
          }
        }
      }
      return resultArray;
    }

    function computeStackedData(ratingsData, dates){
      var length = dates.length;
      var promotersArray = new Array(length).fill(0);
      var passivesArray = new Array(length).fill(0);
      var detractorsArray = new Array(length).fill(0);

      for(var i = 0; i < length; i++){
        var pro = 0, pas = 0, det = 0;
        for(var rating = 1; rating <= 10; rating++){
          var c = (ratingsData[rating.toString()] || [])[i] || 0;
          if(rating >= 9) pro += c;
          else if(rating >= 7) pas += c;
          else det += c;
        }
        promotersArray[i] = pro;
        passivesArray[i] = pas;
        detractorsArray[i] = det;
      }
      return {
        promotersArray: promotersArray,
        passivesArray: passivesArray,
        detractorsArray: detractorsArray
      };
    }

    // La función renderChart se modifica para que, después de crear el gráfico, se llame automáticamente a updateTrendLineWithMethod.
    function renderChart(ratingsData, dates, detailsByDay, itemType, indicator) {
      if(indicator === "table"){
        document.getElementById('chartContainer').style.display = 'none';
        document.getElementById('tableContainer').style.display = 'block';
        return;
      } else {
        document.getElementById('chartContainer').style.display = 'block';
        document.getElementById('tableContainer').style.display = 'none';
      }

      if(indicator === "stacked"){
        renderStackedChart(ratingsData, dates);
        // Luego de renderizar el gráfico de barras, si existe una opción de tendencia (por ejemplo, se desea extender la línea de tendencia) se puede implementar de forma similar.
        return;
      }

      var dataArray = computeDataByIndicator(ratingsData, dates, indicator);
      var labelMap = {
        count:"Cantidad de Evaluaciones",
        average:"Promedio de Puntajes",
        nps:"NPS",
        promoters:"% Promotores",
        passives:"% Neutros",
        detractors:"% Detractores",
        csat:"CSAT (Satisfacción del Cliente)",
        ces:"CES (Esfuerzo del Cliente)",
        response_rate:"Tasa de Respuesta",
        sentiment:"Análisis de Sentimientos"
      };
      var datasetLabel = labelMap[indicator] || "Indicador";

      var data = {
        labels: dates,
        datasets: [{
          label: datasetLabel,
          data: dataArray,
          borderColor: 'rgba(75,192,192,1)',
          backgroundColor: 'rgba(75,192,192,0.2)',
          fill: true,
          tension: 0.4
        }]
      };
      var config = {
        type: 'line',
        data: data,
        plugins: [ChartDataLabels],
        options: {
          responsive: true,
          plugins: {
            title: {
              display: true,
              text: "Indicador: " + datasetLabel,
              align: 'start',
              padding: { top: 0, bottom: 30 },
              font: { size: 20, weight: 'bold', family: 'Arial' }
            },
            legend: {
              display: true,
              position: 'bottom',
              align: 'center'
            },
            tooltip: {
              callbacks: {
                label: function (context) {
                  if (indicator === "sentiment") {
                    return 'Sentimiento: ' + context.parsed.y.toFixed(2);
                  }
                  if (indicator === "average" || indicator === "count") {
                    return context.parsed.y.toFixed(1);
                  }
                  return context.parsed.y;
                }
              }
            },
            datalabels: {
              anchor: 'end',
              align: 'top',
              formatter: function (value, ctx) {
                if (value === 0) { return ''; }
                let lbl = ctx.dataset.label.toLowerCase();
                if (lbl === "cantidad de evaluaciones" || lbl === "promedio de puntajes" || lbl === "csat (satisfacción del cliente)" || lbl === "ces (esfuerzo del cliente)") {
                  if (lbl === "promedio de puntajes") return "E: " + value.toFixed(1);
                  if (lbl === "cantidad de evaluaciones") return "E: " + value.toFixed(0);
                  if (lbl.indexOf("csat") !== -1 || lbl.indexOf("ces") !== -1) {
                    return "E: " + value.toFixed(1) + "%";
                  }
                }
                else if (lbl === "sentiment (análisis de sentimientos)") {
                  return value.toFixed(2);
                }
                else {
                  return value.toFixed(1) + "%";
                }
                return value;
              },
              color: 'black',
              font: { weight: 'bold' }
            }
          },
          onClick: function (evt, elements) {
            if (elements && elements.length) {
              var idx = elements[0].index;
              var selectedDate = dates[idx];
              var dayResponses = detailsByDay[selectedDate] || [];
              showResponsesForDay(selectedDate, dayResponses);
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: (indicator === "count" || indicator === "average") ? "Evaluaciones" : "Valor"
              }
            }
          }
        }
      };
      var ctx = document.getElementById('myChart').getContext('2d');
      if(window.myChartInstance){
        window.myChartInstance.destroy();
        trendLineDataset = null;  // reiniciamos la variable para que se vuelva a agregar
      }
      window.myChartInstance = new Chart(ctx, config);
      // Después de crear el gráfico, se agrega la línea de tendencia según el método actual
      if(window.trendMethod){
        updateTrendLineWithMethod(window.myChartInstance, window.trendMethod);
      }
    }

    function renderStackedChart(ratingsData, dates) {
      var computed = computeStackedData(ratingsData, dates);
      var data = {
        labels: dates,
        datasets: [
          {
            label: "Promotores",
            data: computed.promotersArray,
            backgroundColor: "rgba(75,192,192,0.8)"
          },
          {
            label: "Neutros",
            data: computed.passivesArray,
            backgroundColor: "rgba(255,206,86,0.8)"
          },
          {
            label: "Detractores",
            data: computed.detractorsArray,
            backgroundColor: "rgba(255,99,132,0.8)"
          }
        ]
      };

      var totalEvaluations = computed.promotersArray.map((p, i) =>
        p + computed.passivesArray[i] + computed.detractorsArray[i]
      );

      var config = {
        type: 'bar',
        data: data,
        plugins: [ChartDataLabels],
        options: {
          responsive: true,
          plugins: {
            title: {
              display: true,
              text: "Barras Apiladas (Promotores/Neutros/Detractores)"
            },
            tooltip: {
              callbacks: {
                label: function(context){
                  return context.dataset.label + ': ' + context.parsed.y;
                }
              }
            },
            datalabels: {
              anchor: 'center',
              align: 'center',
              formatter: function(value, ctx) {
                if(value === 0) { return ''; }
                var total = totalEvaluations[ctx.dataIndex];
                var pct = ((value / total) * 100).toFixed(1) + "%";
                return "E: " + value + "\n" + pct;
              },
              color: 'white',
              font: { weight: 'bold' }
            }
          },
          scales: {
            x: { stacked: true },
            y: {
              stacked: true,
              beginAtZero: true,
              title: { display: true, text: 'Cantidad de Evaluaciones' }
            }
          }
        }
      };

      var ctx = document.getElementById('myChart').getContext('2d');
      if(window.myChartInstance){
        window.myChartInstance.destroy();
      }
      window.myChartInstance = new Chart(ctx, config);
    }

    // NUEVA FUNCIÓN: Agregamos ordenación y filtro al mostrar respuestas
    function showResponsesForDay(dateStr, responses) {
      var detailsTitle = document.getElementById('detailsTitle');
      detailsTitle.textContent = "Detalles del día: " + dateStr;
      
      // Reconstruir encabezados con botones de ordenación y filtro
      var theadRow = document.querySelector("#dayDetailsContainer thead tr");
      theadRow.innerHTML = ""; // Limpiar encabezados previos
      
      var thRating = document.createElement('th');
      thRating.id = "thRating";
      thRating.style.cursor = "pointer";
      thRating.addEventListener('click', function(e) {
        if (e.target.closest('.fa-filter')) return;
        sortTable(0);
      });
      thRating.innerHTML = 'Evaluación (1 a 10) <i class="fa fa-sort" aria-hidden="true"></i> <i class="fa fa-filter" id="filterRatingIcon" style="margin-left:5px; cursor:pointer;"></i>';
      
      var thComment = document.createElement('th');
      thComment.id = "thComment";
      thComment.style.cursor = "pointer";
      thComment.addEventListener('click', function(e) {
        if (e.target.closest('.fa-filter')) return;
        sortTable(1);
      });
      thComment.innerHTML = 'Comentario <i class="fa fa-sort" aria-hidden="true"></i> <i class="fa fa-filter" id="filterCommentIcon" style="margin-left:5px; cursor:pointer;"></i>';
      
      theadRow.appendChild(thRating);
      theadRow.appendChild(thComment);
      
      // Agregar eventos a los íconos de filtro
      document.getElementById('filterRatingIcon').addEventListener('click', function(e) {
        e.stopPropagation();
        showFilterModal('rating');
      });
      document.getElementById('filterCommentIcon').addEventListener('click', function(e) {
        e.stopPropagation();
        showFilterModal('comment');
      });
      
      // Rellenar el cuerpo de la tabla
      var tbody = document.getElementById('dayDetailsBody');
      tbody.innerHTML = "";
      if(!responses.length) {
        var row = document.createElement('tr');
        var cell = document.createElement('td');
        cell.colSpan = 2;
        cell.textContent = "No hay respuestas para este día.";
        row.appendChild(cell);
        tbody.appendChild(row);
      } else {
        responses.forEach(function(resp) {
          var row = document.createElement('tr');
          var tdRating = document.createElement('td');
          tdRating.textContent = resp.rating;
          var tdComment = document.createElement('td');
          tdComment.textContent = resp.comment || "Sin Comentario";
          row.appendChild(tdRating);
          row.appendChild(tdComment);
          tbody.appendChild(row);
        });
      }
      document.getElementById('dayDetailsContainer').style.display = 'block';
    }

    // Manejar cambio de indicador en el select
    var chartIndicatorSelect = document.getElementById('chartIndicatorSelect');
    if(chartIndicatorSelect) {
      chartIndicatorSelect.addEventListener('change', function() {
        if(!globalRatingsData || !globalDates || !globalDetails) return;
        var indicator = this.value;
        renderChart(globalRatingsData, globalDates, globalDetails, "Evaluación de Clientes", indicator);
      });
    }

    // 12) Filtrar por rango de fechas
    $('#filterDateBtn').on('click', function() {
      var startDate = $('#startDate').val();
      var endDate = $('#endDate').val();
      if(!startDate || !endDate) {
        alert('Selecciona ambos rangos de fechas');
        return;
      }
      if(startDate > endDate) {
        alert('La fecha de inicio no puede ser posterior a la fecha de fin.');
        return;
      }
      $.ajax({
        url: '{{ url_for("get_ratings_data") }}',
        type: 'GET',
        data: {
          item_uuid: $('#eliminarItemBtn').data('item-id'),
          start_date: startDate,
          end_date: endDate
        },
        success: function(resp) {
          if(resp.error) {
            console.error("Error:", resp.error);
            return;
          }
          globalRatingsData = resp.ratings;
          globalDates = resp.dates;
          globalDetails = resp.details;
          var ratingsHeader = document.getElementById('ratingsHeader');
          Array.from(ratingsHeader.querySelectorAll('th:not(:first-child)')).forEach(th => th.remove());
          var rowIds = ['rating10Row','rating9Row','rating8Row','rating7Row','rating6Row','rating5Row','rating4Row','rating3Row','rating2Row','rating1Row','totalRow'];
          rowIds.forEach(function(rowId) {
            var row = document.getElementById(rowId);
            while(row.children.length > 1) { row.removeChild(row.lastChild); }
          });
          globalDates.forEach(function(dateStr) {
            var th = document.createElement('th');
            th.textContent = dateStr;
            ratingsHeader.appendChild(th);
          });
          fillTableWithCounts(globalRatingsData);
          var currentIndicator = $('#chartIndicatorSelect').val();
          renderChart(globalRatingsData, globalDates, globalDetails, "Evaluación de Clientes", currentIndicator);
        },
        error: function(xhr, status, error) {
          console.error('Error:', error);
        }
      });
    });

    // 13) Descargar gráfico como imagen
    $('#downloadChartBtn').on('click', function() {
      if(window.myChartInstance) {
        var link = document.createElement('a');
        link.href = window.myChartInstance.toBase64Image();
        link.download = 'grafico_dashboard.png';
        link.click();
      } else {
        alert('No hay gráfico para descargar.');
      }
    });

    // =====================================================================================
    // NUEVA SECCIÓN: MENÚ DESPLEGABLE PARA OPCIONES DE TENDENCIA
    // =====================================================================================
    // Se crea el dropdown para elegir entre "Lineal", "Media Móvil", "Descomposición Estacional" y "ARIMA"
    const chartContainer = document.getElementById("chartContainer");
    const trendDropdown = document.createElement("div");
    trendDropdown.className = "dropdown position-absolute";
    trendDropdown.style.top = "10px";
    trendDropdown.style.right = "10px";
    trendDropdown.style.zIndex = "1000";
    chartContainer.style.position = "relative";

    const trendButton = document.createElement("button");
    trendButton.className = "btn btn-primary btn-sm dropdown-toggle";
    trendButton.setAttribute("data-bs-toggle", "dropdown");
    trendButton.textContent = "Tendencia: Lineal";
    trendDropdown.appendChild(trendButton);

    const trendMenu = document.createElement("ul");
    trendMenu.className = "dropdown-menu";

    const trendOptions = ["Lineal", "Media Móvil", "Descomposición Estacional", "ARIMA"];
    trendOptions.forEach(function(option) {
      const li = document.createElement("li");
      const a = document.createElement("a");
      a.className = "dropdown-item";
      a.href = "#";
      a.textContent = option;
      a.addEventListener("click", function(e) {
        e.preventDefault();
        trendButton.textContent = "Tendencia: " + option;
        window.trendMethod = option.toLowerCase();
        if (window.myChartInstance) {
          updateTrendLineWithMethod(window.myChartInstance, window.trendMethod);
        }
      });
      li.appendChild(a);
      trendMenu.appendChild(li);
    });
    trendDropdown.appendChild(trendMenu);
    chartContainer.appendChild(trendDropdown);

    // Función para actualizar (o agregar) la línea de tendencia según el método seleccionado
    function updateTrendLineWithMethod(chart, method) {
      let trendData = [];
      // Se calcula a partir del primer dataset (la serie principal)
      const dataArray = chart.data.datasets[0].data; 

      switch(method) {
        case "lineal":
          trendData = calculateTrendLine(dataArray);
          break;
        case "media móvil":
          trendData = calculateMovingAverage(dataArray, 3);
          break;
        case "descomposición estacional":
          trendData = calculateSeasonalTrend(dataArray);
          break;
        case "arima":
          trendData = calculateARIMATrend(dataArray);
          break;
        default:
          trendData = calculateTrendLine(dataArray);
      }

      if (!trendLineDataset) {
        trendLineDataset = {
          type: "line",
          label: "Tendencia (" + method + ")",
          data: trendData,
          borderColor: "rgba(255, 99, 132, 1)",
          borderWidth: 2,
          borderDash: [5, 5],
          pointRadius: 0,
          fill: false
        };
        chart.data.datasets.push(trendLineDataset);
      } else {
        trendLineDataset.label = "Tendencia (" + method + ")";
        trendLineDataset.data = trendData;
      }
      chart.update();
    }

    // Funciones para calcular la tendencia según distintos métodos:
    function calculateTrendLine(data) {
      const n = data.length;
      if (n < 2) return [];
      const x = Array.from({ length: n }, (_, i) => i + 1);
      const y = data;
      const sumX = x.reduce((a, b) => a + b, 0);
      const sumY = y.reduce((a, b) => a + b, 0);
      const sumXY = x.reduce((acc, xi, i) => acc + xi * y[i], 0);
      const sumX2 = x.reduce((acc, xi) => acc + xi * xi, 0);
      const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
      const intercept = (sumY - slope * sumX) / n;
      return x.map(xi => slope * xi + intercept);
    }

    function calculateMovingAverage(data, windowSize) {
      let result = [];
      for (let i = 0; i < data.length; i++) {
        const start = Math.max(0, i - windowSize + 1);
        const subset = data.slice(start, i + 1);
        const sum = subset.reduce((a, b) => a + b, 0);
        result.push(sum / subset.length);
      }
      return result;
    }

    function calculateSeasonalTrend(data) {
      return calculateMovingAverage(data, 7);
    }

    // Para ARIMA se simula una proyección usando el método de Holt (suavizado lineal)
    function calculateARIMATrend(data) {
      const historical = data.filter(x => x !== null && x !== undefined);
      const m = historical.length;
      const n = data.length;
      if(m === 0) return [];
      const forecastPart = calculateHoltForecast(historical, n - m);
      let result = [];
      for(let i = 0; i < n; i++){
        if(i < m) {
          result.push(historical[i]);
        } else {
          result.push(forecastPart[i - m]);
        }
      }
      return result;
    }
    function calculateHoltForecast(data, nForecasts) {
       let alpha = 0.8, beta = 0.2;
       let level = data[0];
       let trend = data[1] - data[0];
       for (let i = 1; i < data.length; i++){
           let prevLevel = level;
           level = alpha * data[i] + (1 - alpha) * (level + trend);
           trend = beta * (level - prevLevel) + (1 - beta) * trend;
       }
       let forecast = [];
       for (let h = 1; h <= nForecasts; h++){
          forecast.push(level + h * trend);
       }
       return forecast;
    }
    // =====================================================================================
    // FIN DE LA SECCIÓN NUEVA DE TENDENCIAS
    // =====================================================================================

    // 14) Funciones adicionales para orden y filtro en la tabla de detalles
    function sortTable(colIndex) {
      var tbody = document.getElementById('dayDetailsBody');
      var rows = Array.from(tbody.querySelectorAll('tr'));
      var th = document.querySelectorAll("#dayDetailsContainer thead th")[colIndex];
      var sortOrder = th.getAttribute('data-sort') === 'asc' ? 'desc' : 'asc';
      th.setAttribute('data-sort', sortOrder);
      rows.sort(function(a, b) {
        var aText = a.children[colIndex].textContent.trim().toLowerCase();
        var bText = b.children[colIndex].textContent.trim().toLowerCase();
        if (!isNaN(aText) && !isNaN(bText)) {
          return sortOrder === 'asc' ? aText - bText : bText - aText;
        } else {
          return sortOrder === 'asc' ? aText.localeCompare(bText) : bText.localeCompare(aText);
        }
      });
      tbody.innerHTML = "";
      rows.forEach(function(row) {
        tbody.appendChild(row);
      });
    }

    function showFilterModal(column) {
      alert("Función de filtro para " + column + " aún no implementada.");
    }

    // Funciones para pantalla completa, etc.
    document.addEventListener("DOMContentLoaded", function () {
      const fullscreenBtn = document.getElementById("fullscreenToggleBtn");
      const fullscreenModal = new bootstrap.Modal(document.getElementById("fullscreenModal"));
      const fullscreenContent = document.getElementById("fullscreenContent");
      const chartContainer = document.getElementById("chartContainer");
      const tableContainer = document.getElementById("tableContainer");
      const chartIndicatorSelect = document.getElementById("chartIndicatorSelect");

      let lastDisplayedContainer = "chart";

      fullscreenBtn.addEventListener("click", function () {
        fullscreenContent.innerHTML = "";
        if (lastDisplayedContainer === "chart") {
          const clonedChartContainer = chartContainer.cloneNode(true);
          clonedChartContainer.style.height = "100%";
          clonedChartContainer.style.width = "100%";
          fullscreenContent.appendChild(clonedChartContainer);
          const oldCanvas = clonedChartContainer.querySelector("canvas");
          const newCanvas = document.createElement("canvas");
          newCanvas.id = "fullscreenChart";
          oldCanvas.replaceWith(newCanvas);
          setTimeout(() => {
            const ctx = newCanvas.getContext("2d");
            if (window.myChartInstance) {
              new Chart(ctx, window.myChartInstance.config);
            }
          }, 200);
        } else if (lastDisplayedContainer === "table") {
          const clonedTable = tableContainer.cloneNode(true);
          clonedTable.style.height = "100%";
          clonedTable.style.width = "100%";
          fullscreenContent.appendChild(clonedTable);
        }
        fullscreenModal.show();
      });

      document.getElementById("fullscreenModal").addEventListener("hidden.bs.modal", function () {
        // Se mantiene la última vista
      });

      chartIndicatorSelect.addEventListener("change", function () {
        var indicator = this.value;
        if (indicator === "table") {
          tableContainer.style.display = "block";
          chartContainer.style.display = "none";
          lastDisplayedContainer = "table";
        } else {
          chartContainer.style.display = "block";
          tableContainer.style.display = "none";
          lastDisplayedContainer = "chart";
          if (indicator === "stacked") {
            renderStackedChart(globalRatingsData, globalDates);
          } else {
            renderChart(globalRatingsData, globalDates, globalDetails, "Evaluación de Clientes", indicator);
          }
        }
      });
    });
    window.addEventListener('resize', function() {
      if (window.myChartInstance) {
        window.myChartInstance.resize();
      }
    });
  });
</script>
{% endblock %}